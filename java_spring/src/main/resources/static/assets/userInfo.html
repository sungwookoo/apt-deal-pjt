<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <link href="./css/common.css" rel="stylesheet" />
    <title>구해줘 홈즈</title>
  </head>
  <body>
    <!-- Header -->
    <div class="include" data-html="header.html"></div>

    <!-- Main -->
    <main class="container mt-4">
      <div style="height: 150px"></div>
      <!-- contents start -->
      <div class="row">
        <!-- Left side contents-->
        <div class="col-2"></div>
        <!-- Cneter contents-->
        <section class="col-8 bg-dark bg-opacity-50 pt-5 rounded-2 mb-5 text-light">
          <form action="${root}/user" method="POST" id="info">
            <input type="hidden" id="act" name="act" value="" />
            <div class="ms-5">
              <div class="fs-3 fw-bold text-center">회원 정보</div>
              <div class="mb-3 mt-3 row">
                <p class="col-sm-6 text-center">아이디</p>
                <p class="col-sm-6 text-center" id="before-id"></p>
                <input type="hidden" id="id" name="id" />
              </div>
              <div class="mb-3 row">
                <p class="col-sm-6 text-center">비밀번호</p>
                <p class="col-sm-6 text-center info-show" id="before-pass"></p>
                <input
                  type="password"
                  class="info-input col-sm-4"
                  id="pwd"
                  name="pwd"
                  style="display: none"
                />
              </div>
              <div class="mb-3 row">
                <p class="col-sm-6 text-center">이름</p>
                <p class="col-sm-6 text-center info-show" id="before-name"></p>
                <input
                  type="text"
                  class="info-input col-sm-4"
                  id="name"
                  name="name"
                  style="display: none"
                />
              </div>
              <div class="mb-3 row">
                <p class="col-sm-6 text-center">이메일</p>
                <p class="col-sm-6 text-center info-show" id="before-email"></p>
                <div class="input-group col">
                  <input
                    type="text"
                    class="info-input"
                    id="emailId"
                    name="emailId"
                    style="display: none"
                  />
                  <span class="input-group-text info-input" style="display: none">@</span>
                  <select
                    class="form-select info-input"
                    id="emailDomain"
                    name="emailDomain"
                    aria-label="이메일 도메인 선택"
                    style="display: none"
                    required
                  >
                    <option value="">선택</option>
                    <option value="ssafy.com">싸피</option>
                    <option value="google.com">구글</option>
                    <option value="naver.com">네이버</option>
                    <option value="kakao.com">카카오</option>
                  </select>
                </div>
              </div>
              <div class="mb-3 row">
                <p class="col-sm-6 text-center">전화번호</p>
                <p class="col-sm-6 text-center info-show" id="before-phone"></p>
                <input
                  type="tel"
                  class="info-input col-sm-4"
                  id="phone"
                  name="phone"
                  style="display: none"
                />
              </div>
              <div class="mt-5 text-center info-show">
                <button
                  type="button"
                  id="btn-form-modify"
                  class="btn btn-dark me-3"
                  onclick="editOpen()"
                >
                  정보 수정
                </button>
                <button type="button" class="btn btn-dark" onclick="remove()">회원 탈퇴</button>
              </div>
              <div class="mt-5 text-center info-input" style="display: none">
                <button type="button" class="btn btn-dark me-3" onclick="modify()">수정</button>
                <button type="button" class="btn btn-dark" onclick="editCancel()">취소</button>
              </div>
            </div>
          </form>
          <div style="height: 80px"></div>
        </section>
        <!-- Right side contents-->
        <div class="col-2"></div>
      </div>
    </main>

    <!-- Footer -->
    <div class="include" data-html="footer.html"></div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
    <script src="./js/include.js"></script>
    <script src="./js/header.js"></script>

    <!-- Custom JS -->
    <script>
      function editOpen() {
        document.querySelectorAll('.info-show').forEach(info => {
          info.style.display = 'none';
        });
        document.querySelectorAll('.info-input').forEach(info => {
          info.style.display = 'block';
        });
      }

      function editCancel() {
        document.querySelectorAll('.info-show').forEach(info => {
          info.style.display = 'block';
        });
        document.querySelectorAll('.info-input').forEach(info => {
          info.style.display = 'none';
        });
      }

      function modify() {
        let ed = document.querySelector('#emailDomain');
        let userInfo = {
          userId: document.querySelector('#id').value,
          userPassword: document.querySelector('#pwd').value,
          userName: document.querySelector('#name').value,
          emailId: document.querySelector('#emailId').value,
          emailDomain: ed.options[ed.selectedIndex].value,
          userPhone: document.querySelector('#phone').value,
        };
        let config = {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(userInfo),
        };

        fetch(`${root}/api/user/${document.querySelector('#id').value}`, config).then(response => {
          if (response.status == 200) location.href = '/assets/userInfo.html';
        });
      }

      function remove() {
        let config = {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
        };
        fetch(`${root}/api/user/${document.querySelector('#id').value}`, config).then(response => {
          if (response.status == 200) logout();
        });
      }

      window.onload = function () {
        let user = JSON.parse(sessionStorage.getItem('user'));
        fetch(`${root}/api/user/${user.userId}`)
          .then(response => response.json())
          .then(data => {
            console.log(data);
            // 아이디 설정
            document.querySelector('#before-id').innerText = data.userId;
            document.querySelector('#id').value = data.userId;

            // 이름 설정
            document.querySelector('#before-name').innerText = data.userName;
            document.querySelector('#name').value = data.userName;

            // 비밀번호 설정
            document.querySelector('#before-pass').innerText = data.userPassword;
            document.querySelector('#pwd').value = data.userPassword;

            // 이메일 설정
            document.querySelector(
              '#before-email'
            ).innerText = `${data.emailId}@${data.emailDomain}`;
            document.querySelector('#emailId').value = data.emailId;
            const el = document.getElementById('emailDomain');
            const len = el.options.length;
            for (let i = 0; i < len; i++) {
              console.log(data.emailDomain, el.options[i].value);
              if (el.options[i].value == data.eamilDomain) {
                el.options[i].selected = true;
                break;
              }
            }

            // 전화번호 설정
            document.querySelector('#before-phone').innerText = data.userPhone;
            document.querySelector('#phone').value = data.userPhone;
          });
      };
    </script>
  </body>
</html>
